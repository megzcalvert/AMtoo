---
title: "AM Panel Variable Selection 2017"
author: "Megan Calvert"
date: "`r format(Sys.time(), '%B %d, %Y')`"
header-includes:
   - \usepackage{bbm}
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_chunk$set(dev = 'pdf')
library(readr)
library(tidyverse)
library(glmnet)
library(janitor)
library(RMySQL)
library(ggplot2)
library(data.table)
library(lme4)
library(car)
library(GGally)
library(MVN)
library(broom)
```

# Phenotype Selection to include in Multivariate GWAS

Data will be pulled directly from SQL server, converted from long format to 
wide format. The HDDT is calculated via Jesse's regression based approach. 
High-throughput phenotypes are added. Outliers are removed, before broad-sense 
heritability and Best Linear Unbiased Estimators are calculated. Normality 
will be assessed before and after. Various model selection methods will 
then be assessed

```{r SQL, warning=FALSE, include=FALSE}
# Connect to database
wheatgenetics = dbConnect(MySQL( ),user="megzcalvert",
                          
                          dbname='wheatgenetics', host='beocat.cis.ksu.edu',
                          
                          password = " " , port = 6306) 

#SQL Query to get all AM Panel phenotype data

pheno_query <- "SELECT phenotype.entity_id,

phenotype.trait_id,

phenotype.phenotype_value,

phenotype.phenotype_date,

plot.plot_name AS 'Variety',

plot.block,

plot.rep,

plot.range,

plot.column

FROM wheatgenetics.phenotype LEFT JOIN 

wheatgenetics.plot ON plot.plot_id = phenotype.entity_id

WHERE wheatgenetics.phenotype.entity_id LIKE '17ASH1%';"

#run the query to get plot information

pheno <- dbGetQuery(wheatgenetics, pheno_query)

#save original data
print(getwd( )) #get working directory set if needed
setwd("~/Dropbox/Research_Poland_Lab/AM Panel")

saveRDS(pheno, 
        "~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/Pheno17.RDS") #save original plot information 


dbDisconnect(wheatgenetics) #disconnect from database

```

### Long Format Summaries

```{r LongFormat, echo=FALSE, warning=FALSE}
#### Data summaries of long format from database

## clean workspace
rm(list = objects()); ls()

getwd()

sessionInfo() # useful infos **reproducible research**

#Read in original data
pheno_long<- readRDS(
  "~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/Pheno17.RDS")

str(pheno_long) # structure
head(pheno_long, 10)

iniNames<- tabyl(pheno_long$Variety)
names(iniNames)[1:2] <- c("Variety", "Count")

## Long Format Summaries with modified names

pheno_long$Variety<- tolower(pheno_long$Variety)
pheno_long$Variety<- str_replace_all(pheno_long$Variety, " ", "_")
pheno_long$Variety<- str_replace_all(pheno_long$Variety, "-", "_")
pheno_long$Variety<- str_replace_all(pheno_long$Variety, "'", "")

#Function to add a column based on a portion of text in another column
ff = function(x, patterns, replacements = patterns, fill = NA, ...)
{
  stopifnot(length(patterns) == length(replacements))
  
  ans = rep_len(as.character(fill), length(x))    
  empty = seq_along(x)
  
  for(i in seq_along(patterns)) {
    greps = grepl(patterns[[i]], x[empty], ...)
    ans[empty[greps]] = replacements[[i]]  
    empty = empty[!greps]
  }
  
  return(ans)
}

#Adding a year column based on the entity_id
pheno_long$year<- ff(pheno_long$entity_id, 
                     c("15ASH", "16ASH", "17ASH"), 
                     c("15", "16", "17"),
                     "NA", ignore.case = TRUE)

modNames<- tabyl(pheno_long$Variety)
names(modNames)[1:2] <- c("Variety", "Count")
knitr::kable(tabyl(pheno_long$trait_id), 
             digits = 4, 
             caption = "Number of observations per trait", 
             table.attr = "style='width:50%;'")
knitr::kable(tabyl(pheno_long$rep), 
             digits = 4, 
             caption = "Number of observations of reps", 
             table.attr = "style='width:50%;'")
knitr::kable(tabyl(pheno_long$year), 
             digits = 4, 
             caption = "Number of observations per year", 
             table.attr = "style='width:50%;'")

```

### Summaries after removing blank lines
```{r Blanks, echo=FALSE, warning=FALSE}
### Removing lines that do not fit the assumptions

modNames <- modNames %>% 
  filter(Variety != "blank")

pheno_long<- semi_join(pheno_long, modNames, 
                       by = c('Variety' = 'Variety')) 

knitr::kable(tabyl(pheno_long$trait_id), 
             digits = 4, 
             caption = "Final number of observations per traits", 
             table.attr = "style='width:50%;'")
knitr::kable(tabyl(pheno_long$rep), 
             digits = 4, 
             caption = "Final number of observations per rep", 
             table.attr = "style='width:50%;'")
knitr::kable(tabyl(pheno_long$year), 
             digits = 4, 
             caption = "Final number of observations per year", 
             table.attr = "style='width:50%;'")

```

### Addition of HDDT from PCTHEAD and changing to wide Format

```{r HDDT, echo=FALSE, warning=FALSE}

#Add columns for awns and heading date
pheno_long$awns<- ifelse(pheno_long$phenotype_value == "Awned", 
                         pheno_long$phenotype_value,
                         NA)

awns<- pheno_long[ , c(1,11)]

awns<- as.data.frame(na.omit(awns))

#Removing confounding phenotypes  
pheno_long$phenotype_date = as.Date(pheno_long$phenotype_date) ## set the date as a Date type
pheno_long<- subset(pheno_long, pheno_long$trait_id != "AWNS" )

pheno_pcthead<- subset(pheno_long, pheno_long$trait_id == "PCTHEAD" )
pheno_long<- subset(pheno_long, pheno_long$trait_id != "PCTHEAD" )

pheno_pcthead$phenotype_date = as.Date(pheno_pcthead$phenotype_date) ## set the date as a Date type
pheno_pcthead = pheno_pcthead[!is.na(pheno_pcthead$phenotype_date), ] ## remove some rows that are missing the phenotype date
pheno_pcthead = pheno_pcthead[order(pheno_pcthead$entity_id, 
                                    pheno_pcthead$phenotype_date), ]  ## sort the rows by plot and date

runLogReg = function(dates, pctHEAD){
  res = data.frame(phi1=NA, phi2=NA, phi3=NA, hday=NA, hdate=NA)
  
  if(sum(!is.na(pctHEAD))==0){return(list(res=res, 
                                          dates=dates, 
                                          pctHEAD = pctHEAD, 
                                          pred=NA))} ## skip if no phenotype data
  if(max(pctHEAD, na.rm=TRUE)<60){return(list(res=res, 
                                              dates=dates, 
                                              pctHEAD = pctHEAD,
                                              pred=NA))} ## skip plots that never reach 50% heading
  
  days = yday(dates) ## convert to day of year
  
  ## add some dummy variables for 0% and 100% at 10, 20, 30 days before/after the phenotyping range ##
  days = c(days, min(days)-c(10,20,30), max(days)+c(10,20,30))
  pctH = c(pctHEAD, c(0,0,0,100,100,100))
  
  ##find initial starting values for phi2 and phi3,  fix phi1 at 100
  phi1 = 100
  phi2 = coef(lm(logit(pctH/phi1)~days))[1]
  phi3 = coef(lm(logit(pctH/phi1)~days))[2]
  
  heading_model<-try(nls(pctH~100/(1+exp(-(phi2+phi3*days))), 
                         start=list(phi2=phi2,phi3=phi3), 
                         trace=FALSE), silent=TRUE)
  
  if(class(heading_model)=="try-error"){return(list(res=res, 
                                                    dates=dates, 
                                                    pctHEAD = pctHEAD, 
                                                    pred=NA))}  ## skip if doesn't converge
  
  #update model coefficients for predictions
  phi2 = coef(heading_model)[1]
  phi3 = coef(heading_model)[2]
  
  ## get predicted value
  pred = getPred(phi1, phi2, phi3)
  
  hday = pred$x[which.min(abs(pred$y-50))] ## get heading day of year
  hdate = as.Date(paste(year(dates[1]),"-01-01", sep="")) + hday ## convert to date
  
  res = data.frame(phi1, phi2, phi3, hday, hdate) ## set values
  
  return(list(res=res, dates=dates, pctHEAD = pctHEAD, pred=pred))
  
}

getPred = function(phi1, phi2, phi3){
  
  x<-c((80*10):(150*10))/10  #construct a range of x values for all days of year
  y<-phi1/(1+exp(-(phi2+phi3*x))) #predicted y values
  pred<-data.frame(x,y) #create the prediction data frame
  
  return(pred)
}

#################### TEST NON-LINEAR FIT #############################

## heading date calculation results
plots = unique(pheno_pcthead$entity_id) ## get list of plots
##plots = plots[grepl("17ASH", plots)] ## work with only 17ASH plots
head.dates = data.frame(plot_id = plots, day=NA, phi1=NA, phi2=NA, phi3=NA)  ## data frame to store results

##first example
test.plot='17ASH10002'

sample=pheno_pcthead[pheno_pcthead$entity_id==test.plot,]
sample$phenotype_value<- as.numeric(sample$phenotype_value)

test = runLogReg(dates=sample$phenotype_date, pctHEAD=sample$phenotype_value)
hddt<- as.data.frame(test$res)

plots = unique(pheno_pcthead$entity_id)

#head.dates = rep(list(list(vis=list(), length=length(plots)))) ## data frame to store results
#names(head.dates) = plots

for (i in plots){
  ##for (i in 681:length(plots)){  ## quick fix for running only 17ASH plots
  ##for (i in 1000:1010){
  ## subsample the data for the plot for analysis
  ## run for visual scores
  sample=pheno_pcthead[pheno_pcthead$entity_id == i,]
  sample$phenotype_value<- as.numeric(sample$phenotype_value)
  #sample=pheno_pcthead[pheno_pcthead$entity_id==plots[i],]
  vis.logistic = runLogReg(dates=sample$phenotype_date, 
                           pctHEAD=sample$phenotype_value)
  n<- as.data.frame(vis.logistic$res)
  hddt<- rbind(hddt, n)
  #head.dates[[plots[i]]] = list(vis=vis.logistic)
  ##print(head.dates[[plots[i]]]$vis$res)
  
}

hddt<- hddt[2:nrow(hddt),]
hddt<- cbind(plots,hddt)
plotDates<- hddt[,c(1,5)]

pheno_long$phenotype_value<-as.numeric(as.character(pheno_long$phenotype_value))

write.table(pheno_long, file="~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/Pheno_Long17.txt",
            col.names=TRUE, row.names=FALSE, sep="\t", quote=FALSE)

pheno_long<- fread("~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/Pheno_Long17.txt", header = T)

#Changing from long to wide format
pheno_Wide <- mutate(dcast(pheno_long,  
                           entity_id + year + Variety + rep + block + 
                             range + column ~ trait_id, 
                           value.var = "phenotype_value", 
                           fun.aggregate = median, 
                           na.rm = TRUE),
                     Variety = factor(Variety),
                     rep = factor(rep))

pheno_Wide <- left_join(pheno_Wide, awns)
pheno_Wide <- left_join(pheno_Wide, plotDates, by = c("entity_id" = "plots"))

histFacet.plot <- function(x, results, info, ...) {
  
  md<- names(x) %in% c("rn","Taxa","year","rep","block",
                       "column","range", "entity_id")
  traits <- names(x[ , !md])
  
  for (i in traits) {
    plots<-ggplot(data = x, aes_string(x = i)) + 
      geom_histogram(colour="black", fill="white") + 
      #facet_grid(x$year ~ .) +
      geom_vline(aes(xintercept = mean(i)),col='red',size=2) +
      theme_bw() +
      xlab(paste0(i)) +
      ylab("Frequency") +
      theme(panel.grid.major = element_blank()) +
      theme(panel.grid.minor = element_blank()) +
      theme(axis.text = element_text(size = 15)) +
      theme(axis.title = element_text(size = 15)) +
      theme(strip.text = element_text(size = 15)) 
    ggsave(paste0(i,"_",info,".pdf"),path=paste(results, sep=''))
    print(plots)
  }
}


```

### Addition of HTP

```{r HTP, warning=FALSE, echo=FALSE}
## Addition of HTP traits for 2017 data

gndvi<- fread(input = "~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/2017_Ashland_AM3_traits_UAS/2017_ASH_AM_GNDVI.txt")
grvi<- fread(input = "~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/2017_Ashland_AM3_traits_UAS/2017_ASH_AM_GRVI.txt")
ndre<- fread(input = "~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/2017_Ashland_AM3_traits_UAS/2017_ASH_AM_NDRE.txt")
ndvi<- fread(input = "~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/2017_Ashland_AM3_traits_UAS/2017_ASH_AM_NDVI.txt")
nir<- fread(input = "~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/2017_Ashland_AM3_traits_UAS/2017_ASH_AM_NIR.txt")
redE<- fread(input = "~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/2017_Ashland_AM3_traits_UAS/2017_ASH_AM_RedEdge.txt")
hHTP<- fread(input = "~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/2017_Ashland_AM3_traits_UAS/2017_ASH_AM_height_4.csv")
names(hHTP) <- c("Plot_id","H1Nov","H8Nov","H11Nov","H23Nov","H28Nov",
                 "H1Dec","H31Mar","H6Apr","H12Apr","H17Apr","H23Apr",
                 "H3May","H5May","H12May","H23May","H6Jun","H9Jun")

pheno_Wide<- left_join(pheno_Wide, gndvi, by = c("entity_id" = "Plot_id"))
pheno_Wide<- left_join(pheno_Wide, grvi, by = c("entity_id" = "Plot_id"))
pheno_Wide<- left_join(pheno_Wide, ndre, by = c("entity_id" = "Plot_id"))
pheno_Wide<- left_join(pheno_Wide, ndvi, by = c("entity_id" = "Plot_id"))
pheno_Wide<- left_join(pheno_Wide, nir, by = c("entity_id" = "Plot_id"))
pheno_Wide<- left_join(pheno_Wide, redE, by = c("entity_id" = "Plot_id"))
pheno_Wide<- left_join(pheno_Wide, hHTP, by = c("entity_id" = "Plot_id"))

head(pheno_Wide)

knitr::kable(tabyl(pheno_Wide$year), 
             digits = 4, 
             caption = "Number of observations per year", 
             table.attr = "style='width:50%;'")

names(pheno_Wide)[names(pheno_Wide)=="Variety"] <- "Taxa"

write.table(pheno_Wide, "~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/Pheno_17.txt", sep = "\t") #To be used in the gapit_rrBLUP_AM.R file

rm(gndvi, grvi,hHTP,iniNames,modNames,ndre,ndvi,nir,pheno_long,
   pheno_Wide,redE,vis.logistic,test,sample,hddt,head.dates,n,pheno_pcthead,
   plotDates, i, plots, test.plot)

```

### Visual summaries of raw data

```{r RawVis, echo=FALSE, fig.height=5, fig.width=5, message=FALSE, warning=FALSE}
pheno<- read.table("~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/Pheno_17.txt", sep = "\t", header = TRUE, stringsAsFactors = TRUE)

myvars <- names(pheno) %in% c("awns") 
pd<- pheno[!myvars]


#histFacet.plot(pd,'~/Dropbox/Research_Poland_Lab/AM Panel/Figures/Hist/','raw_2017')


cpg_dot<- ggplot(data = pheno, aes(x = pheno$PTHT, y = pheno$GRWT)) +
  geom_point() + 
  geom_smooth(method = lm) +
  xlab("Plant Height (cm)") + 
  ylab("Grain weight") +
  theme_bw() +
  theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor = element_blank()) +
  theme(axis.text = element_text(size = 15)) +
  theme(axis.title = element_text(size = 15)) +
  theme(strip.text = element_text(size = 15)) 

cpg_dot

cmg_dot<- ggplot(data = pheno, aes(x = pheno$MOIST, y = pheno$GRWT)) +
  geom_point() + 
  geom_smooth(method = lm) +
  xlab("Moisture") + 
  ylab("Grain weight") +
  theme_bw() +
  theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor = element_blank()) +
  theme(axis.text = element_text(size = 15)) +
  theme(axis.title = element_text(size = 15)) +
  theme(strip.text = element_text(size = 15)) 

cmg_dot

cpm_dot<- ggplot(data = pheno, aes(x = pheno$PTHT, y = pheno$MOIST)) +
  geom_point() + 
  geom_smooth(method = lm) +
  xlab("Plant Height (cm)") + 
  ylab("Moisture") +
  theme_bw() +
  theme(panel.grid.major = element_blank()) +
  theme(panel.grid.minor = element_blank()) +
  theme(axis.text = element_text(size = 15)) +
  theme(axis.title = element_text(size = 15)) +
  theme(strip.text = element_text(size = 15)) 

cpm_dot

```

```{r Correlations, fig.height=12, fig.width=12, echo=FALSE, message=FALSE, warning=FALSE}

correlations<- function(x, ...) {
  
  md<- names(x) %in% c("rn","Taxa","year","rep","block","column","range", 
                       "entity_id","HDDT")
  corDa<-x[ , !md]
  nums <- sapply(corDa, is.numeric)
  corDa<- corDa[ , nums]
  
  ggcorr(corDa, label_size = 2)
}

correlations(pheno)

ggpairs(pheno[,c(8:14)])

pheno$awns<- ff(pheno$awns, "Awned", 1, 2, ignore.case =TRUE)
pheno$awns<- as.numeric(pheno$awns)
```


### Removing outliers, calculating H2 and BLUES
```{r lme4, message=FALSE, warning=FALSE}
pheno<- pheno[ ,c(3:ncol(pheno))] 

snpChip <- read_delim("~/Dropbox/Research_Poland_Lab/AM Panel/Genotype_Database/90KsnpChipHapMap/AMsnpChipImputed.hmp.txt", 
                      "\t", escape_double = FALSE, trim_ws = TRUE)

snpChip<- snpChip %>% 
  clean_names()

chipLines<- as.data.frame(unique(colnames(snpChip[, 13:ncol(snpChip)])))
names(chipLines)[1] <- "snpChip"

remove_outliers <- function(x, na.rm = T, ...) {
  qnt <- quantile(x, probs=c(.25, .75), na.rm = na.rm, ...)
  caps <- quantile(x, probs = c(.05, .95), na.rm = na.rm)
  H <- 1.5 * IQR(x, na.rm = na.rm)
  y <- x
  #abs(scale(x)) >= 3
  y[x < (qnt[1] - H)] <- NA
  y[x > (qnt[2] + H)] <- NA
  y
}

pheno<- pheno[, c(1:3,6:ncol(pheno))]
pheno<- as.data.frame(semi_join(pheno, chipLines, by = c("Taxa" = "snpChip")))

boxplot.stats(pheno$awns)$out
boxplot.stats(pheno$MOIST)$out
boxplot.stats(pheno$GRWT)$out
boxplot.stats(pheno$PTHT)$out
boxplot.stats(pheno$hday)$out
pheno[,c(4:8,10:ncol(pheno))]<- as.data.frame(
  lapply(pheno[,c(4:8,10:ncol(pheno))], remove_outliers)
)
boxplot.stats(pheno$awns)$out
boxplot.stats(pheno$MOIST)$out
boxplot.stats(pheno$GRWT)$out
boxplot.stats(pheno$PTHT)$out

pheno$Taxa <- as.factor(pheno$Taxa)
pheno$rep <- as.factor(pheno$rep)
pheno$block <- as.factor(pheno$block)

calcH2r <- function(dat, fill = NA, ...) {
  
  r=length(table(dat$rep))
  
  effectvars <- names(dat) %in% c("block", "rep", "Taxa", "year", "column", 
                                  "row", "experiment_id")
  
  t <- colnames(dat[ , !effectvars])
  
  for (i in t) {
    
    print(paste("Working on trait", i))
    h = as.data.frame(VarCorr(lmer(
      paste0(i, "~ (1|Taxa) + (1|rep) + (1|rep:block)"), data = dat)))
    H2= h[1,4] / (h[1,4] + (h[4,4] / r)) 
    print(H2)
  }
  
}

calcH2r(pheno)

blues.rb <- function(traits, dat = ".") {
  b<- as.data.frame(
    fixef(lmer(paste0(traits, "~ 0 + Taxa + (1|rep) + (1|rep:block)"), 
               data = dat))
  )
}


#####2017
effectvars <- names(pheno) %in% 
  c("block", "rep", "Taxa", "year", "column", "row", "experiment_id", "HDDT")

traits <- colnames(pheno[ , !effectvars])

blues<- lapply(traits, blues.rb, dat = pheno)

blues <- map2(blues, traits, ~ set_names(..1, ..2) %>%
                rownames_to_column(var = "Taxa")) %>%
  reduce(full_join)
blues$Taxa <- str_replace_all(blues$Taxa, "Taxa", "")


write.table(blues, "~/Dropbox/Research_Poland_Lab/AM Panel/Phenotype_Database/cleanPheno17Blues.txt",
            quote = FALSE, row.names = F, col.names = T, sep = "\t", 
            fileEncoding = "UTF-8")

rm(cmg_dot,cpg_dot,cpm_dot,pd,snpChip,myvars,awns,chipLines)

pheno<- as.data.frame( pheno[, !names(pheno) %in% 
                               c("NormGRWT","TESTWT","awns" )])
pheno<- na.omit(pheno)

blues<- as.data.frame(blues[, !names(blues) %in% 
                              c("NormGRWT", "TESTWT", "awns")])
blues<- na.omit(blues)

```

### Clean data visualisation
#### Plot-level data
```{r CleanFig, fig.height=5, fig.width=5, echo=FALSE, message=FALSE, warning=FALSE}

#histFacet.plot(pheno,'~/Dropbox/Research_Poland_Lab/AM Panel/Figures/Hist/','clean_2017')
```

```{r CleanCorr, fig.height=12, fig.width=12, echo=FALSE, message=FALSE, warning=FALSE}

correlations(pheno)

ggpairs(pheno[,c(4:8)])
```
BLUEs data
```{r BlueVis, fig.height=5, fig.width=5, echo=FALSE, message=FALSE, warning=FALSE}

#histFacet.plot(blues,'~/Dropbox/Research_Poland_Lab/AM Panel/Figures/Hist/','blues_2017')
```

```{r bluesCorr, fig.height=12, fig.width=12, echo=FALSE, message=FALSE, warning=FALSE}

correlations(blues)

ggpairs(blues[,c(2:6)])
```

## Normality Tests 
Testing for univariate normality in the plot-level and BLUEs data.
Plot level data normality tests

```{r NormalityPlot, echo=FALSE, message=TRUE, warning=FALSE}

plotlevel<-mvn(pheno[, !names(pheno) %in% c("Taxa","rep","block")], 
               subset = NULL, 
               mvnTest = c("mardia", "hz", "royston", "dh","energy"), 
               covariance = TRUE, 
               tol = 1e-25, 
               alpha = 0.5,
               scale = FALSE, 
               transform = "none", 
               R = 1000,
               univariateTest = c("SW", "CVM", "Lillie", "SF", "AD"),
               univariatePlot = "qq", 
               multivariatePlot = "none",
               multivariateOutlierMethod = "none", 
               showOutliers = FALSE,
               showNewData = FALSE)

knitr::kable(plotlevel$univariateNormality, 
             digits = 4, 
             caption = "Plot-level Normality tests", 
             table.attr = "style='width:50%;'")

```

#### BLUES data normality tests
```{r NormalityBlues, echo=FALSE, message=TRUE, warning=FALSE}
bluelevel<-mvn(blues[, !names(blues) %in% c("Taxa")], 
               subset = NULL, 
               mvnTest = c("mardia", "hz", "royston", "dh","energy"), 
               covariance = TRUE, 
               tol = 1e-25, 
               alpha = 0.5,
               scale = FALSE, 
               transform = "none", 
               R = 1000,
               univariateTest = c("SW", "CVM", "Lillie", "SF", "AD"),
               univariatePlot = "qq", 
               multivariatePlot = "none",
               multivariateOutlierMethod = "none", 
               showOutliers = FALSE,
               showNewData = FALSE)

knitr::kable(bluelevel$univariateNormality, 
             digits = 4, 
             caption = "BLUE Normality tests", 
             table.attr = "style='width:50%;'")

```

## Step-wises regression

Step-wise regression was performed with the MASS package in both directions. 

### BLUEs data
```{r Step-wiseBlue, message=FALSE, warning=FALSE, include=FALSE}
library(MASS)
bluesT<- as.data.frame(blues[, !names(blues) %in% c("Taxa")])
fitBlue <- lm(GRWT ~ .,data=bluesT)
selectedFitBlue <- step(fitBlue, direction = "both")
knitr::kable(selectedFitBlue$anova, 
             caption = "ANOVA model comparison summary", 
             table.attr = "style='width:90%;'") # display results
summary(selectedFitBlue)
bluSW<- selectedFitBlue$call
```

```{r StepWiseResultsBlue, fig.height=13, fig.width=13, echo=FALSE, message=FALSE, warning=FALSE}

knitr::kable(selectedFitBlue$anova, 
             digits = 4, 
             caption = "BLUES Step-wise Regression", 
             table.attr = "style='width:90%;'") # display results
summary(selectedFitBlue)
au<- broom::augment(selectedFitBlue)
au %>%
  gather(x,val,-contains(".")) %>%
  ggplot(aes(val,.resid)) +
  geom_point() + 
  facet_wrap(~x, scales = "free")

```

### Refining the Step-wise regression to account for Multicollinearity

#### BLUEs VIF
```{r blueVIF, fig.height=13, fig.width=13, message=FALSE, warning=FALSE}

all_vifs <- car::vif(selectedFitBlue) #Used to check Multicollinearity
print(all_vifs) #Anything above 10 is likely to be a problem in a strong model

signif_all <- names(all_vifs)

# Remove vars with VIF> 4 and re-build model until none of VIFs don't exceed 10.
while(any(all_vifs > 10)){
  var_with_max_vif <- names(which(all_vifs == max(all_vifs)))  # get the var with max vif
  signif_all <- signif_all[!(signif_all) %in% var_with_max_vif]  # remove
  myFormBVIF <- as.formula(paste("GRWT ~ ", 
                                 paste (signif_all, collapse=" + "), sep=""))  # new formula
  selectedFitBlue <- lm(myFormBVIF, data=bluesT)  # re-build model with new formula
  all_vifs <- car::vif(selectedFitBlue)
}
summary(selectedFitBlue)
car::vif(selectedFitBlue)

myFormBVIF
selectedFitBlue<-lm(myFormBVIF, 
                    data = bluesT)
au<- broom::augment(selectedFitBlue)
au %>%
  gather(x,val,-contains(".")) %>%
  ggplot(aes(val,.resid)) +
  geom_point() + 
  facet_wrap(~x, scales = "free")

all_vars <- names(selectedFitBlue[[1]])[-1]  # names of all X variables
# Get the non-significant vars
summ <- summary(selectedFitBlue)  # model summary
pvals <- summ[[4]][, 4]  # get all p values
not_significant <- character()  # init variables that aren't statsitically significant
not_significant <- names(which(pvals > 0.1))
not_significant <- not_significant[!not_significant %in% "(Intercept)"]  # remove 'intercept'. Optional!

# If there are any non-significant variables, 
while(length(not_significant) > 0){
  all_vars <- all_vars[!all_vars %in% not_significant[1]]
  myFormBVS <- as.formula(paste("GRWT ~ ", 
                                paste (all_vars, collapse=" + "), sep=""))  # new formula
  selectedFitBlue <- lm(myFormBVS, data=bluesT)  # re-build model with new formula
  
  # Get the non-significant vars.
  summ <- summary(selectedFitBlue)
  pvals <- summ[[4]][, 4]
  not_significant <- character()
  not_significant <- names(which(pvals > 0.1))
  not_significant <- not_significant[!not_significant %in% "(Intercept)"]
}
summary(selectedFitBlue)
car::vif(selectedFitBlue)

myFormBVS
selectedFitBlue<-lm(myFormBVS, 
                    data = bluesT)
au<- broom::augment(selectedFitBlue)
au %>%
  gather(x,val,-contains(".")) %>%
  ggplot(aes(val,.resid)) +
  geom_point() + 
  facet_wrap(~x, scales = "free")

```

## Summary of Regression models derived from Step-wise selection

### BLUEs data

#### Step-wise Regression in both directions
```{r bluSWres, echo=FALSE, message=FALSE, warning=FALSE} 
print(bluSW)
```

#### Step-wise Regression in both directions with control for Multicollinearity 

```{r bluSWVifres, echo=FALSE, message=FALSE, warning=FALSE} 
print(myFormBVIF)
```

#### Step-wise Regression in both directions with control for Multicollinearity
and variable significance

```{r bluSWVSres, echo=FALSE, message=FALSE, warning=FALSE} 
print(myFormBVS)
```

## LASSO Variable Selection
LASSO variable selection performed with the glmnet package

### BLUEs
```{r LassoBLUE, fig.width=12,fig.height=12, message=FALSE, warning=FALSE}
library(glmnet)
bluPred<- data.matrix(blues[, !names(blues) %in% c("GRWT","Taxa")])
bluResp<- data.matrix(blues[, names(blues) %in% c("GRWT")])

lassBlu <- glmnet(bluPred,bluResp,alpha = 1)
plot(lassBlu,xvar = "lambda", label = T,cex=2, cex.lab=1.5, cex.axis=1.5)
plot(lassBlu,xvar = "dev", label = T,cex=2, cex.lab=1.5, cex.axis=1.5)
lassBlu$beta@Dimnames[[1]]
coef(lassBlu)

```

Select phenotpyes BLUEs: 8,23,54,6,7,24,32,10,55

GNDVI_20170505,NDRE_20170503,H8Nov,GNDVI_20170417,GNDVI_20170503,NDRE_20170505,
NDVI_20170505 GNDVI_20170523,H11Nov

```{r LassoBluRes, fig.height=13, fig.width=13, echo=FALSE, message=FALSE, warning=FALSE}
fitLassoB<- lm(GRWT ~ GNDVI_20170505 + NDRE_20170503 + H8Nov + GNDVI_20170417 +
                 GNDVI_20170503 + NDRE_20170505 + NDVI_20170505 +
                 GNDVI_20170523 + H11Nov, data = blues)
summary(fitLassoB)

fitLassoB$anova

au<- broom::augment(fitLassoB)
au %>%
  gather(x,val,-contains(".")) %>%
  ggplot(aes(val,.resid)) +
  geom_point() + 
  facet_wrap(~x, scales = "free")

```


```{r LassoBLUESelec, fig.width=12,fig.height=12, message=FALSE, warning=FALSE}

bluPredS<- bluPred[,c(8,23,54,6,7,24,32,10,55)]
head(bluPredS)

lassBlu <- glmnet(bluPredS,bluResp,alpha = 1)

plot(lassBlu,xvar = "lambda", label = T,cex=2, cex.lab=1.5, cex.axis=1.5)
plot(lassBlu,xvar = "dev", label = T,cex=2, cex.lab=1.5, cex.axis=1.5)

tidied_Blu <- tidy(lassBlu)
glance_Blu <- glance(lassBlu)
coef(lassBlu)

cvLasBlu<- cv.glmnet(bluPred,bluResp, 
                     type.measure = "mse", 
                     nfolds = 10, 
                     alpha = 1)
plot(cvLasBlu)
cvLasBlu$lambda.min
cvLasBlu$lambda.1se

coef(cvLasBlu)
cvLasBluL<- glmnet(bluPred,bluResp, lambda = cvLasBlu$lambda.min, alpha = 1)

coef(cvLasBluL)

```

## Model Validation

Leave one out cross-validation and K-fold cross-validation. These validations
will also be performed on the Correlation models and Correlation*Heritability 
models. The caret package will be used to perform this validation

### Leave One Out Cross Validation 

#### BLUES level
```{r LOOCVblu, echo=TRUE, message=FALSE, warning=FALSE}
library(caret)
set.seed(123)
train.control <- caret::trainControl(method = "LOOCV",
                                     number = 10)
# Full Model 
bluLoCV <- train(GRWT ~., data = blues, method = "lm",
                 trControl = train.control)
# Summarize Full Model
print(bluLoCV)

# Corr Model
bluCorrLoCV <- train(GRWT ~ GNDVI_20170417 + GNDVI_20170503 +	GNDVI_20170505 + 
                       GNDVI_20170512 + GRVI_20170417 +	GRVI_20170503 +	
                       GRVI_20170505 +	GRVI_20170512 + NDRE_20170417 + 
                       NDRE_20170503 + NDRE_20170505 + NDRE_20170512 + 
                       NDVI_20170503 + RedEdge_20170505 + RedEdge_20170512, 
                     data = blues, method = "lm",
                     trControl = train.control)
# Summarize Corr Model
print(bluCorrLoCV)

# Her*Corr Model
bluCorrHerLoCV <- train(GRWT ~ NDRE_20170512 + GRVI_20170505 + NDRE_20170505 + 
                          GRVI_20170512 + GRVI_20170503 + NDRE_20170503 + 
                          GNDVI_20170512 + GNDVI_20170505 + GNDVI_20170503 + 
                          NDRE_20170417 + GRVI_20170417 + GNDVI_20170417 + 
                          NDVI_20170503 + NDVI_20170505 + NDVI_20170417, 
                        data = blues, method = "lm",
                        trControl = train.control)
# Summarize Full Model
print(bluCorrHerLoCV)

# Back Selection 
bluBSLoCV <- train(GRWT ~ BYDV + MOIST + hday + GNDVI_20170331 + 
                     GNDVI_20170417 + GNDVI_20170503 + GNDVI_20170505 + 
                     GNDVI_20170523 + GRVI_20170503 + GRVI_20170512 + 
                     NDRE_20170503 + NDRE_20170505 + NDRE_20170609 + 
                     NDVI_20170505 + NDVI_20170512 + NDVI_20170602 + 
                     NDVI_20170609 + NIR_20170512 + NIR_20170523 + 
                     NIR_20170602 + NIR_20170609 + RedEdge_20170503 + 
                     RedEdge_20170512 + RedEdge_20170523 + RedEdge_20170602 + 
                     H8Nov + H11Nov + H23Nov + H28Nov + H1Dec + 
                     H31Mar + H6Apr + H12Apr + H17Apr + H6Jun, 
                   data = bluesT, 
                   method = "lm",
                   trControl = train.control)

# Summarize Full Model
print(bluBSLoCV)

# Back Selection VIF
bluBSVLoCV <- train(GRWT ~ BYDV + MOIST + hday + GNDVI_20170331 + 
                      GNDVI_20170417 + GNDVI_20170523 + GRVI_20170512 + 
                      NDRE_20170609 + NDVI_20170505 + NDVI_20170602 + 
                      NIR_20170512 + NIR_20170523 + NIR_20170609 + 
                      RedEdge_20170503 + RedEdge_20170602 + H8Nov + H11Nov + 
                      H1Dec + H31Mar + H17Apr + H6Jun, 
                    data = bluesT, 
                    method = "lm",
                    trControl = train.control)

# Summarize Full Model
print(bluBSVLoCV)

# Back Selection VIF and significance
bluBSVSLoCV <- train(GRWT ~ MOIST + hday + GNDVI_20170331 + GNDVI_20170417 + 
                       GRVI_20170512 + NDRE_20170609 + NIR_20170512 + 
                       RedEdge_20170602 + H11Nov + H31Mar + H17Apr + H6Jun, 
                     data = bluesT, 
                     method = "lm",
                     trControl = train.control)

# Summarize Full Model
print(bluBSVSLoCV)

# LASSO 
bluLassLoCV <- train(GRWT ~ GNDVI_20170505 + NDRE_20170503 + H8Nov + 
                       GNDVI_20170417 + GNDVI_20170503 + NDRE_20170505 + 
                       NDVI_20170505 + GNDVI_20170523 + H11Nov, 
                     data = bluesT, 
                     method = "lm",
                     trControl = train.control)
# Summarize Full Model
print(bluLassLoCV)

# LASSO minimised lambda cv
bluLasLcvLoCV <- train(GRWT ~ MOIST + hday + GNDVI_20170609 + GRVI_20170523 + 
                         NDRE_20170417 + NDRE_20170503 + NDRE_20170512 + 
                         NDRE_20170523 + H12Apr + H9Jun, 
                       data = bluesT, 
                       method = "lm",
                       trControl = train.control)
# Summarize Full Model
print(bluLasLcvLoCV)

# LASSO minimised lambda 
bluLasLmlLoCV <- train(GRWT ~ BYDV + MOIST + PTHT + hday + GNDVI_20170331 + 
                         GNDVI_20170417 + GNDVI_20170609 + GRVI_20170512 + 
                         GRVI_20170523 + GRVI_20170609 + NDRE_20170503 + 
                         NDRE_20170512 + NDRE_20170523 + NDVI_20170331 + 
                         NIR_20170503 + NIR_20170505 + NIR_20170602 + 
                         RedEdge_20170523 + H1Nov + H11Nov + H23Nov + 
                         H31Mar + H12Apr + H5May + H23May + H6Jun + H9Jun, 
                       data = bluesT, 
                       method = "lm",
                       trControl = train.control)
# Summarize Full Model
print(bluLasLmlLoCV)
```

### Repeat K-Fold Cross Validation 

#### BLUES level
```{r kCVblu, echo=TRUE, message=FALSE, warning=FALSE}

set.seed(123)
train.control <- trainControl(## 10-fold CV
  method = "repeatedcv",
  number = 10,
  ## repeated ten times
  repeats = 10)
# Full Model 
blukCV <- train(GRWT ~., data = blues, method = "lm",
                trControl = train.control)
# Summarize Full Model
print(blukCV)

# Corr Model
bluCorrkCV <- train(GRWT ~ GNDVI_20170417 + GNDVI_20170503 +	GNDVI_20170505 + 
                      GNDVI_20170512 + GRVI_20170417 +	GRVI_20170503 +	
                      GRVI_20170505 +	GRVI_20170512 + NDRE_20170417 + 
                      NDRE_20170503 + NDRE_20170505 + NDRE_20170512 + 
                      NDVI_20170503 + RedEdge_20170505 + RedEdge_20170512, 
                    data = blues, 
                    method = "lm",
                    trControl = train.control)
# Summarize Corr Model
print(bluCorrkCV)

# Her*Corr Model
bluCorrHerkCV <- train(GRWT ~ NDRE_20170512 + GRVI_20170505 + NDRE_20170505 + 
                         GRVI_20170512 + GRVI_20170503 + NDRE_20170503 + 
                         GNDVI_20170512 + GNDVI_20170505 + GNDVI_20170503 + 
                         NDRE_20170417 + GRVI_20170417 + GNDVI_20170417 + 
                         NDVI_20170503 + NDVI_20170505 + NDVI_20170417, 
                       data = blues, method = "lm",
                       trControl = train.control)

# Summarize Full Model
print(bluCorrHerkCV)

# Back Selection 
bluBSkCV <- train(GRWT ~ BYDV + MOIST + hday + GNDVI_20170331 + 
                    GNDVI_20170417 + GNDVI_20170503 + GNDVI_20170505 + 
                    GNDVI_20170523 + GRVI_20170503 + GRVI_20170512 + 
                    NDRE_20170503 + NDRE_20170505 + NDRE_20170609 + 
                    NDVI_20170505 + NDVI_20170512 + NDVI_20170602 + 
                    NDVI_20170609 + NIR_20170512 + NIR_20170523 + 
                    NIR_20170602 + NIR_20170609 + RedEdge_20170503 + 
                    RedEdge_20170512 + RedEdge_20170523 + 
                    RedEdge_20170602 + H8Nov + H11Nov + H23Nov + H28Nov + 
                    H1Dec + H31Mar + H6Apr + H12Apr + H17Apr + H6Jun,
                  data = bluesT, method = "lm",
                  trControl = train.control)

# Summarize Full Model
print(bluBSkCV)

# Back Selection VIF
bluBSVkCV <- train(GRWT ~ BYDV + MOIST + hday + GNDVI_20170331 + 
                     GNDVI_20170417 + GNDVI_20170523 + GRVI_20170512 + 
                     NDRE_20170609 + NDVI_20170505 + NDVI_20170602 + 
                     NIR_20170512 + NIR_20170523 + NIR_20170609 + 
                     RedEdge_20170503 + RedEdge_20170602 + H8Nov + H11Nov + 
                     H1Dec + H31Mar + H17Apr + H6Jun, 
                   data = bluesT, 
                   method = "lm",
                   trControl = train.control)
# Summarize Full Model
print(bluBSVkCV)

# Back Selection VIF and significance
bluBSVSkCV <- train(GRWT ~ MOIST + hday + GNDVI_20170331 + GNDVI_20170417 + 
                      GRVI_20170512 + NDRE_20170609 + NIR_20170512 + 
                      RedEdge_20170602 + H11Nov + H31Mar + H17Apr + H6Jun, 
                    data = bluesT, 
                    method = "lm",
                    trControl = train.control)
# Summarize Full Model
print(bluBSVSkCV)

# LASSO 
bluLasskCV <- train(GRWT ~ GNDVI_20170505 + NDRE_20170503 + H8Nov + 
                      GNDVI_20170417 + GNDVI_20170503 + NDRE_20170505 + 
                      NDVI_20170505 + GNDVI_20170523 + H11Nov, 
                    data = bluesT, 
                    method = "lm",
                    trControl = train.control)
# Summarize Full Model
print(bluLasskCV)

# LASSO minimised lambda cv
bluLasLcvkCV <- train(GRWT ~ MOIST + hday + GNDVI_20170609 + GRVI_20170523 + 
                        NDRE_20170417 + NDRE_20170503 + NDRE_20170512 + 
                        NDRE_20170523 + H12Apr + H9Jun, 
                      data = bluesT, 
                      method = "lm",
                      trControl = train.control)
# Summarize Full Model
print(bluLasLcvkCV)

# LASSO minimised lambda 
bluLasLmlkCV <- train(GRWT ~ BYDV + MOIST + PTHT + hday + GNDVI_20170331 + 
                        GNDVI_20170417 + GNDVI_20170609 + GRVI_20170512 + 
                        GRVI_20170523 + GRVI_20170609 + NDRE_20170503 + 
                        NDRE_20170512 + NDRE_20170523 + NDVI_20170331 + 
                        NIR_20170503 + NIR_20170505 + NIR_20170602 + 
                        RedEdge_20170523 + H1Nov + H11Nov + H23Nov + H31Mar + 
                        H12Apr + H5May + H23May + H6Jun + H9Jun, 
                      data = bluesT, 
                      method = "lm",
                      trControl = train.control)
# Summarize Full Model
print(bluLasLmlkCV)
```

## Model Comparison
```{r Model Comparison, fig.width=12,fig.height=12, message=FALSE, warning=FALSE}
# Full Model 
bluk <- lm(GRWT ~., data = blues)
# Summarize Full Model
summary(blukCV)
blukCV$anova

bluCorr<- lm(GRWT ~ GNDVI_20170417 + GNDVI_20170503 +	GNDVI_20170505 + 
               GNDVI_20170512 + GRVI_20170417 +	GRVI_20170503 +	
               GRVI_20170505 +	GRVI_20170512 + NDRE_20170417 + 
               NDRE_20170503 + NDRE_20170505 + NDRE_20170512 + 
               NDVI_20170503 + RedEdge_20170505 + RedEdge_20170512, 
             data = blues)
summary(bluCorr)

bluCorr$anova

au<- broom::augment(bluCorr)
au %>%
  gather(x,val,-contains(".")) %>%
  ggplot(aes(val,.resid)) +
  geom_point() + 
  facet_wrap(~x, scales = "free")

bluCorrHer<- lm(GRWT ~ NDRE_20170512 + GRVI_20170505 + NDRE_20170505 + 
                  GRVI_20170512 + GRVI_20170503 + NDRE_20170503 + 
                  GNDVI_20170512 + GNDVI_20170505 + GNDVI_20170503 + 
                  NDRE_20170417 + GRVI_20170417 + GNDVI_20170417 + 
                  NDVI_20170503 + NDVI_20170505 + NDVI_20170417, 
                data = blues)
summary(bluCorr)

bluCorrHer$anova

au<- broom::augment(bluCorrHer)
au %>%
  gather(x,val,-contains(".")) %>%
  ggplot(aes(val,.resid)) +
  geom_point() + 
  facet_wrap(~x, scales = "free")

# Back Selection VIF and significance
bluBSVSk <- lm(GRWT ~ MOIST + hday + GNDVI_20170331 + GNDVI_20170417 + 
                 GRVI_20170512 + NDRE_20170609 + NIR_20170512 + 
                 RedEdge_20170602 + H11Nov + H31Mar + H17Apr + H6Jun, 
               data = bluesT)
# Summarize Full Model
summary(bluBSVSk)
bluBSVSk$anova

# LASSO 
bluLassk <- lm(GRWT ~ GNDVI_20170505 + NDRE_20170503 + H8Nov +
                 GNDVI_20170417 + GNDVI_20170503 + NDRE_20170505 +
                 NDVI_20170505 + GNDVI_20170523 + H11Nov, 
               data = bluesT)
# Summarize Full Model
summary(bluLassk)
bluLassk$anova

# LASSO minimised lambda cv
bluLasLcvk <- lm(GRWT ~ MOIST + hday + GNDVI_20170609 + GRVI_20170523 + 
                   NDRE_20170417 + NDRE_20170503 + NDRE_20170512 + 
                   NDRE_20170523 + H12Apr + H9Jun, 
                 data = bluesT)
# Summarize Full Model
summary(bluLasLcvk)
bluLasLcvk$anova

bluLasLml <- lm(GRWT ~ BYDV + MOIST + PTHT + hday + GNDVI_20170331 + 
                  GNDVI_20170417 + GNDVI_20170609 + GRVI_20170512 + 
                  GRVI_20170523 + GRVI_20170609 + NDRE_20170503 + 
                  NDRE_20170512 + NDRE_20170523 + NDVI_20170331 + 
                  NIR_20170503 + NIR_20170505 + NIR_20170602 + 
                  RedEdge_20170523 + H1Nov + H11Nov + H23Nov + H31Mar + 
                  H12Apr + H5May + H23May + H6Jun + H9Jun, 
                data = blues)

summary(bluLasLml)

bluLasLml$anova

au<- broom::augment(bluLasLml)
au %>%
  gather(x,val,-contains(".")) %>%
  ggplot(aes(val,.resid)) +
  geom_point() + 
  facet_wrap(~x, scales = "free")

totalSum<- anova(bluk,bluCorr,bluCorrHer,
                 bluBSVSk,bluLassk,bluLasLcvk,
                 bluLasLml)
totalSum
```

